# lottery 抽奖

> 最近重新看了之前做的抽奖项目代码(后端服务)，重新学习一下

## 需求

### 描述

简单地说，实现活动期间，消耗积分/分享可以获得抽奖机会，在一系列限制条件下抽奖

### 限制条件

- 活动时间内

- 用户账号

- 游戏机会来源：

  1. 每天消耗积分可增加 1 次

  1. 微信分享可增加 1 次

- 中奖概率：

  1. 奖品概率

  1. 奖品中奖的时间线分布(这个比较重要!!!)，目前粒度是小时

  1. 上一时间区间的奖品未发完则顺延下一时间区间

  1. 上一天的奖品未发完则顺延下一天

  1. 已中奖则不能再抽中

## 实现

### 数据模型

ps:几个数据模型，这里仅记录一些主要字段

#### 游戏模型

|    字段     |  类型  |   解释   |                       备注                        |
| :---------: | :----: | :------: | :-----------------------------------------------: |
|    name     | string |   名称   |                                                   |
|    code     | string |   代码   |                                                   |
| description | string |   描述   |                                                   |
|   status    | string |   状态   | pending 未开始/start 进行中/end 结束,默认 pending |
| start_time  |  date  | 开始时间 |                                                   |
|  end_time   |  date  | 结束时间 |                                                   |

#### 机会规则模型

|       字段       |  类型   |            解释            |                   备注                   |
| :--------------: | :-----: | :------------------------: | :--------------------------------------: |
|       name       | string  |            名称            |                                          |
|     game_id      | string  |        游戏模型 id         |                                          |
|      status      | string  |            状态            | valid 有效的/invalid 无效的,默认 invalid |
|       kind       | string  |          机会来源          |        jifen 积分消耗/share 分享         |
|   jifen_amount   | number  |        每次消耗积分        |                                          |
|   jifen_times    | number  |          最大次数          |                                          |
| jifen_times_unit | string  |        机会次数单位        |             day 天/month 月              |
| rule_whole_valid | boolean | 这条规则是否整场活动都有效 |                默认 false                |

#### 用户机会模型

|      字段      |  类型  |                      解释                      |                                                备注                                                |
| :------------: | :----: | :--------------------------------------------: | :------------------------------------------------------------------------------------------------: |
|    user_id     | string |                    用户 id                     |                                                                                                    |
|    game_id     | string |                  游戏模型 id                   |                                                                                                    |
| game_chance_id | string |                机会规则模型 id                 |                                                                                                    |
|     status     | string |                      状态                      | invalid 未购买/pending 未使用/using 使用中/used 已使用/epxired 已过期/failed 创建失败,默认 invalid |
|   pending_at   |  date  |                  机会创建时间                  |                                                                                                    |
|    using_at    |  date  | 机会被使用时间(中间态,后端关注,前端不需要关注) |                                                                                                    |
|   expired_at   |  date  |                机会被使用后时间                |                                                                                                    |
