# redis

## 概述

> redis 是什么？

Redis(Remote Dictionary Server )，即远程字典服务 !
是一个开源的使用 ANSI C 语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value 数据库， 并提供多种语言的 API。
redis 会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了 master-slave(主从)同步。
免费和开源!是当下最热门的 NoSQL 技术之一!也被人们称之为结构化数据库!

## 一些基础知识

1. redis 有 16 个数据库, 默认使用 0

```redis
127.0.0.1:6379> select 2    #切换数据库
OK
127.0.0.1:6379[2]> dbsize   #查看数据库大小
(integer) 0
127.0.0.1:6379[2]> set name jehadsama
OK
127.0.0.1:6379[2]> set age 18
OK
127.0.0.1:6379[2]> get name
"jehadsama"
127.0.0.1:6379[2]> get age
"18"
127.0.0.1:6379[2]> dbsize
(integer) 2
127.0.0.1:6379[2]> keys *    #列出当前表的所有key
1) "name"
2) "age"
127.0.0.1:6379[2]> flushdb   #清除当前数据库
OK
127.0.0.1:6379[2]> flushall  #清除所有数据库
OK

```

## 关于缓存的穿透、击穿、雪崩

## 缓存穿透

概念：请求一个不存在的 key，redis 没有，数据库也没有，当大量请求时造成数据库崩溃

解决：在请求数据库层前，加个中间层，判断有没有请求键存在，不存在就不查数据库

- 缓存空值
- 布隆过滤器

### 布隆过滤器

按上面总结，这个中间层是不是直接用一个字典存起来就好，毕竟时间复杂度 O(1)。然鹅，存在内存里，假如数据量远大于服务器内存。。。这种情况下，布隆过滤器是一个很好的缓冲选择。

#### 布隆过滤器是什么

布隆过滤器是一种占用空间很小的数据结构，它由一个很长的二进制向量和一组 Hash 映射函数组成，可用于检索一个元素是否在一个集合中，空间效率和查询时间都比一般的算法要好的多，缺点是有一定的误识别率和删除困难。

#### 布隆过滤器的原理

假设有一个 具有 n 个元素的集合 A， k 个哈希散列函数。

将 A 的每个元素 通过每个哈希散列函数 映射到一个长度为 a 位的数组 B 中的不同位置上，这些位置上的二进制数均设置为 1。

如果待检查的元素，经过这 k 个哈希散列函数的映射后，发现其 k 个 在 B 中 位置上的二进制数全部为 1，这个元素很可能属于集合 A，反之，一定不属于集合 A。

#### 如何减少布隆过滤器的误差

- 多一些哈希函数映射，降低哈希碰撞的概率

- 同时增加 B 数组的 bit 长度，可以增大 hash 函数生成的数据的范围，也可以降低哈希碰撞的概率

## 缓存击穿

概念：大量请求访问一个 key(比如热点数据)，当这个 key 失效时，瞬间请求打到数据库导致崩溃

解决：

- key 永不过期
- 利用分布式锁(实现同时只能一个进程访问数据库)

## 缓存雪崩

概念：大量的 key 过期(有效期自然过期或服务器宕机停电等),导致大量请求瞬间打到数据库造成崩溃

解决：

- 多 redis 服务(异地多活)
- 限流降级(缓存失效后，通过加锁或队列来控制数据库读写缓存的线程数量，比如某个 key 只允许一个线程查询数据和写缓存，其它线程等待)
- 数据预热(在正式部署之前，把可能的数据先预先访问，在即将发生大并发访问前手动触发加载缓存不同的 key，设置不同的过期时间，让缓存失效的时间尽量均匀)
